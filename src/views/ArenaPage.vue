<template>
  <div class="min-h-screen bg-gray-900 flex flex-col safe-area-top safe-area-bottom">
    <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
    <div class="flex-shrink-0 p-4 bg-dark-100/50 backdrop-blur-sm border-b border-dark-300">
      <div class="flex items-center justify-between">
        <!-- ËøîÂõûÊåâÈíÆ -->
       
        <!-- <button
          @click="$router.back()"
          class="p-2 text-white/70 hover:text-white transition-colors"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button> -->

        <!-- ÂìÅÁâåËØç -->
        <div class="">
          <h1 class="text-white font-bold text-lg">ÊØîÊØîË∞ÅÊõ¥Áæé</h1>
        </div>
        
        <!-- Áä∂ÊÄÅ‰ø°ÊÅØ -->
        <div class="flex items-center space-x-4 text-sm">
         
          
         

          <!-- ÊéíË°åÊ¶úÊåâÈíÆ -->
          <button
            @click="$router.push('/leaderboard')" 
            class="flex items-center space-x-1 text-purple-400"
          >
            <span>üèÜ</span>
            <span>ÊéíË°åÊ¶ú</span>
          </button>

          <button
            @click="$router.push('/profile')"
            class="px-4 py-2 bg-gradient-primary rounded-full flex items-center justify-center space-x-1.5
                   shadow-lg shadow-primary/20 hover:shadow-primary/30 transition-all duration-200
                   active:scale-95 hover:-translate-y-0.5"
          >
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M12 4v16m8-8H4"></path>
            </svg>
            <span class="text-white text-sm font-bold">È¢úÂÄºÊâìÂàÜ</span>
          </button>
          
         
        </div>
      </div>
      
      <!-- ËøõÂ∫¶Êù°ÔºàÊñ∞ÊâãÂºïÂØºÔºâ -->
      <div v-if="userStore.votesNeeded > 0 && false" class="mt-3">
        <div class="flex items-center justify-between text-xs text-white/70 mb-1">
          <span>Ëß£ÈîÅÂàÜÊï∞ËøõÂ∫¶</span>
          <span>{{ 10 - userStore.votesNeeded }}/10</span>
        </div>
        <div class="w-full bg-dark-300 rounded-full h-2">
          <div 
            class="bg-gradient-primary h-2 rounded-full transition-all duration-500"
            :style="{ width: `${((10 - userStore.votesNeeded) / 10) * 100}%` }"
          ></div>
        </div>
      </div>
    </div>
    
    
    
    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="flex-1 flex flex-col h-full items-center justify-center">

      <!-- ‰∏ìÂú∫ÈÄâÊã© -->
    <div class="flex-shrink-0 p-4 bg-dark-100/30">
      <div class="flex justify-center">
        <div class="flex space-x-2 overflow-visible pb-2 max-w-md relative">
          <!-- ÈªòËÆ§ÊòæÁ§∫ÂΩìÂâçÂàÜÁ±ª -->
          <div class="flex items-center space-x-2 relative">
            <button
              class="px-4 py-2 rounded-full text-sm font-medium bg-dark-200 text-white"
            >
              {{ currentCategoryDisplay }}
            </button>
            
            <!-- Êõ¥Â§öÊåâÈíÆ -->
            <button
              @click="toggleCategoryDropdown"
              class="px-3 py-2 rounded-full text-sm font-medium bg-dark-200 text-white/70 hover:text-white category-trigger"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
              </svg>
            </button>

            <!-- ÂàÜÁ±ª‰∏ãÊãâËèúÂçï -->
            <div
              v-show="showCategoryDropdown"
              class="absolute top-full left-0 mt-2 w-64 bg-dark-100/95 rounded-xl shadow-lg shadow-black/50 backdrop-blur-lg z-50 category-dropdown"
              style="min-width: 240px;"
            >
              <div class="py-2">
                <div
                  v-for="category in categories"
                  :key="category.id"
                  class="mb-2 last:mb-0"
                >
                  <!-- ‰∏ªÂàÜÁ±ª -->
                  <div 
                    class="px-4 py-2 text-white font-medium text-sm border-b border-white/10 "
                  >
                    {{ category.name }}
                  </div>
                  <!-- Â≠êÂàÜÁ±ª -->
                  <div class="py-1">
                    <button
                      v-for="subCategory in category.subcategories"
                      :key="subCategory.id"
                      @click="selectCategory(category.id, subCategory.id)"
                      class="w-full px-6 py-2 text-left text-sm transition-colors duration-200 flex items-center space-x-2"
                      :class="[
                        currentMainCategory === category.id && currentSubCategory === subCategory.id
                          ? 'bg-gradient-primary text-white'
                          : 'text-white/70 hover:text-white hover:bg-dark-200/50'
                      ]"
                    >
                      <span class="w-1.5 h-1.5 rounded-full" :class="[
                        currentMainCategory === category.id && currentSubCategory === subCategory.id
                          ? 'bg-white'
                          : 'bg-white/50'
                      ]"></span>
                      <span>{{ subCategory.name }}</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

      <!-- ÊØîËµõÂå∫Âüü -->
      <div v-if="currentMatch && !isLoading" class=" flex flex-col">
        <!-- ÁÖßÁâáÂØπÂÜ≥Âå∫Âüü -->
        <div class="flex-1 flex flex-col md:flex-row items-center justify-center relative p-2 md:p-4">
          <!-- ‰∏äÊñπ/Â∑¶‰æßÁÖßÁâá -->
          <div 
            class="w-[80vw] md:w-[400px] aspect-square relative" 
            
          >
            <div class="absolute inset-0 m-2">
              <div class="photo-card h-full group relative">
                <img
                  :src="currentMatch.user1.photo"
                  :alt="currentMatch.user1.name"
                  class="w-full h-full object-cover rounded-2xl"
                  @error="handleImageError"
                />
                
                <!-- ÊäïËØâÊåâÈíÆ - ‰ªéÁÇπÂáªÂå∫Âüü‰∏≠ÂàÜÁ¶ªÂá∫Êù• -->
                <div class="absolute top-4 right-4 z-10">
                  <button
                    @click.stop="openReportDialog(currentMatch.user1.id)"
                    class="w-8 h-8 bg-black/50 rounded-full flex items-center justify-center backdrop-blur-sm
                           hover:bg-black/70 transition-colors"
                  >
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                  </button>
                </div>
                
                <!-- ÊäïÁ•®ÁÇπÂáªÂå∫Âüü - Áã¨Á´ãÁöÑÂ±Ç -->
                <div 
                  class="absolute inset-0 cursor-pointer"
                  @click="vote(currentMatch.user1.id)"
                >
                  <!-- ÈÄâÊã©ÈÅÆÁΩ© -->
                  <div class="absolute inset-0 bg-gradient-primary/0 group-hover:bg-gradient-primary/20 transition-all duration-300 flex items-center justify-center rounded-2xl">
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ÂàÜÊï∞ÊòæÁ§∫ -->
                <div class="absolute top-4 left-4 bg-black/50 rounded-lg px-2 py-1 backdrop-blur-sm">
                  <span class="text-white text-sm font-medium">{{ formatScore(currentMatch.user1.eloScore) }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- VSÊåáÁ§∫Âô® -->
          <div class="flex-shrink-0 mx-4 md:mx-8 my-2 md:my-4">
            <div class="w-10 h-10 md:w-16 md:h-16 bg-dark-200 rounded-full flex items-center justify-center">
              <span class="text-white font-bold text-base md:text-lg">VS</span>
            </div>
          </div>
          
          <!-- ‰∏ãÊñπ/Âè≥‰æßÁÖßÁâá -->
          <div 
            class="w-[80vw] md:w-[400px] aspect-square relative" 
            
          >
            <div class="absolute inset-0 m-2">
              <div class="photo-card h-full group relative">
                <img
                  :src="currentMatch.user2.photo"
                  :alt="currentMatch.user2.name"
                  class="w-full h-full object-cover rounded-2xl"
                  @error="handleImageError"
                />
                
                <!-- ÊäïËØâÊåâÈíÆ - ‰ªéÁÇπÂáªÂå∫Âüü‰∏≠ÂàÜÁ¶ªÂá∫Êù• -->
                <div class="absolute top-4 right-4 z-10">
                  <button
                    @click.stop="openReportDialog(currentMatch.user2.id)"
                    class="w-8 h-8 bg-black/50 rounded-full flex items-center justify-center backdrop-blur-sm
                           hover:bg-black/70 transition-colors"
                  >
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                  </button>
                </div>
                
                <!-- ÊäïÁ•®ÁÇπÂáªÂå∫Âüü - Áã¨Á´ãÁöÑÂ±Ç -->
                <div 
                  class="absolute inset-0 cursor-pointer"
                  @click="vote(currentMatch.user2.id)"
                >
                  <!-- ÈÄâÊã©ÈÅÆÁΩ© -->
                  <div class="absolute inset-0 bg-gradient-primary/0 group-hover:bg-gradient-primary/20 transition-all duration-300 flex items-center justify-center rounded-2xl">
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ÂàÜÊï∞ÊòæÁ§∫ -->
                <div class="absolute top-4 left-4 bg-black/50 rounded-lg px-2 py-1 backdrop-blur-sm">
                  <span class="text-white text-sm font-medium">{{ formatScore(currentMatch.user2.eloScore) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Â∫ïÈÉ®Êìç‰ΩúÊ†è -->
        <div class="flex-shrink-0 p-4 flex flex-col justify-center space-x-4 justify-center items-center">
          <button
            @click="skipMatch"
            class="btn-secondary md:w-[100px]"
            :disabled="isVoting"
          >
            Ë∑≥Ëøá
          </button>
          
          
        </div>
      </div>
      
      <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
      <div v-else class="flex-1 flex items-center justify-center">
        <div class="text-center flex flex-col items-center justify-center">
          <div class="w-16 h-16 rounded-full flex items-center justify-center mb-4 animate-pulse">
            <svg class="w-8 h-8 text-white animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
          <p class="text-white/70">Ê≠£Âú®ÂáÜÂ§áÂØπÂÜ≥...</p>
        </div>
      </div>
    </div>
    <ReportDialog
      :show="showReportDialog"
      :image-id="reportImageId"
      @close="closeReportDialog"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onBeforeUnmount, watch } from 'vue'
import { useRouter } from 'vue-router'
import { useUserStore } from '@/stores/user'
import { useArenaStore } from '@/stores/arena'
import { useNotificationStore } from '@/stores/notification'
import ReportDialog from '@/components/ReportDialog.vue'

const router = useRouter()
const userStore = useUserStore()
const arenaStore = useArenaStore()
const notificationStore = useNotificationStore()

// ÂìçÂ∫îÂºèÁä∂ÊÄÅ
const isLoading = ref(true)
const showCategoryDropdown = ref(false)
const currentMainCategory = ref('normal')
const currentSubCategory = ref('normal_female')
const showReportDialog = ref(false)
const reportImageId = ref(null)

// ËÆ°ÁÆóÂ±ûÊÄß
const currentMatch = computed(() => arenaStore.currentMatch)
const isVoting = computed(() => arenaStore.isVoting)
const userFuel = computed(() => userStore.userFuel)
const userLevel = computed(() => userStore.userLevel)
const todayVotes = computed(() => arenaStore.todayVotes)

// ÂàÜÁ±ªÁõ∏ÂÖ≥
const categories = [
  {
    id: 'normal',
    name: 'Á¥†‰∫∫',
    subcategories: [
      { id: 'normal_female', name: 'Â•≥Áîü' },
      { id: 'normal_male', name: 'Áî∑Áîü' },
    ]
  },
  {
    id: 'celebrity',
    name: 'ÊòéÊòü',
    subcategories: [
      { id: 'celebrity_female', name: 'Â•≥Áîü' },
      { id: 'celebrity_male', name: 'Áî∑Áîü' },
    ]
  },
  {
    id: 'ai',
    name: 'AI',
    subcategories: [
      { id: 'ai_female', name: 'Â•≥Áîü' },
      { id: 'ai_male', name: 'Áî∑Áîü' },
    ]
  }
]

const currentCategoryDisplay = computed(() => {
  const mainCategory = categories.find(c => c.id === currentMainCategory.value)
  const subCategory = mainCategory?.subcategories.find(s => s.id === currentSubCategory.value)
  return `${mainCategory?.name} ¬∑ ${subCategory?.name}`
})

const toggleCategoryDropdown = () => {
  console.log('Toggling dropdown, current state:', showCategoryDropdown.value)
  showCategoryDropdown.value = !showCategoryDropdown.value
  console.log('New state:', showCategoryDropdown.value)
}

const selectCategory = (mainCategoryId, subCategoryId) => {
  currentMainCategory.value = mainCategoryId
  currentSubCategory.value = subCategoryId
  showCategoryDropdown.value = false
  generateNewMatch(subCategoryId)
}

const handleClickOutside = (event) => {
  if (showCategoryDropdown.value) {
    const dropdown = document.querySelector('.category-dropdown')
    const trigger = document.querySelector('.category-trigger')
    if (dropdown && !dropdown.contains(event.target) && trigger && !trigger.contains(event.target)) {
      showCategoryDropdown.value = false
    }
  }
}

// Ê†ºÂºèÂåñÂàÜÊï∞ÊòæÁ§∫
const formatScore = (eloScore) => {
  if (eloScore >= 2200) return `${(9.5 + (eloScore - 2200) / 200).toFixed(1)}‚òÖ`
  if (eloScore >= 2000) return `${(8.5 + (eloScore - 2000) / 133.33).toFixed(1)}‚òÖ`
  if (eloScore >= 1800) return `${(7.5 + (eloScore - 1800) / 200).toFixed(1)}‚òÖ`
  if (eloScore >= 1600) return `${(6.5 + (eloScore - 1600) / 200).toFixed(1)}‚òÖ`
  if (eloScore >= 1400) return `${(5.5 + (eloScore - 1400) / 200).toFixed(1)}‚òÖ`
  return `${Math.max(1, 4.5 + (eloScore - 1200) / 200).toFixed(1)}‚òÖ`
}

// ‰øÆÊîπÊäïÁ•®ÊñπÊ≥ï
const vote = async (winnerId) => {
  if (!currentMatch.value || isVoting.value) return
  
  try {
    // ‰øùÂ≠òÂΩìÂâçÊØîËµõÁöÑÂºïÁî®ÔºåÈò≤Ê≠¢ÂºÇÊ≠•Êìç‰ΩúËøáÁ®ã‰∏≠Ë¢´Ê∏ÖÁ©∫
    const currentMatchSnapshot = { ...currentMatch.value }
    
    const result = await arenaStore.vote(winnerId)
    
    // ÊòæÁ§∫ÊàêÂäüÈÄöÁü•
    notificationStore.showSuccess('ÊäïÁ•®ÊàêÂäüÔºÅ', 'üéâ +5 ÁáÉÊñô')
    
    // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥ÂêéÁîüÊàêÊñ∞ÊØîËµõ
    setTimeout(() => {
      generateNewMatch()
    }, 1500)
    
  } catch (error) {
    console.error('ÊäïÁ•®Â§±Ë¥•:', error)
  }
}

// Ë∑≥ËøáÊØîËµõ
const skipMatch = () => {
  arenaStore.skipMatch()
  generateNewMatch()
}

// ÁîüÊàêÊñ∞ÊØîËµõ
const generateNewMatch = (categoryId = currentSubCategory.value) => {
  if (!arenaStore.canVote) {
    return
  }
  
  isLoading.value = true
  
  // Á°Æ‰øùÊ∏ÖÈô§ÂΩìÂâçÊØîËµõ
  currentMatch.value = null
  
  // Ê®°ÊãüÁΩëÁªúÂª∂Ëøü
  setTimeout(() => {
    try {
      const match = arenaStore.generateMatch(categoryId)
      if (!match) {
        notificationStore.showError('ÊöÇÊó∂Ê≤°ÊúâÂèØÁî®ÁöÑÂØπÂÜ≥ÔºåËØ∑Á®çÂêéÂÜçËØï')
        return
      }
      isLoading.value = false
    } catch (error) {
      console.error('ÁîüÊàêÊØîËµõÂ§±Ë¥•:', error)
      notificationStore.showError('ÁîüÊàêÊØîËµõÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï')
    } finally {
      isLoading.value = false
    }
  }, 500)
}

// Â§ÑÁêÜÂõæÁâáÂä†ËΩΩÈîôËØØ
const handleImageError = (event) => {
  event.target.src = '/placeholder-avatar.jpg'
}

// ÊâìÂºÄÊäïËØâÂØπËØùÊ°Ü
const openReportDialog = (imageId) => {
  reportImageId.value = imageId
  showReportDialog.value = true
}

// ÂÖ≥Èó≠ÊäïËØâÂØπËØùÊ°Ü
const closeReportDialog = () => {
  showReportDialog.value = false
  reportImageId.value = null
}

// ÂàùÂßãÂåñ
onMounted(() => {
  generateNewMatch()
})

// ÁõëÂê¨Áî®Êà∑ÁáÉÊñôÂèòÂåñ
watch(() => userStore.userFuel, (newFuel, oldFuel) => {
  if (newFuel === 0 && oldFuel > 0) {
    notificationStore.showWarning('ÁáÉÊñôÂ∑≤Áî®ÂÆåÔºåÈúÄË¶ÅËé∑ÂæóÊõ¥Â§öÁáÉÊñôÊâçËÉΩÁªßÁª≠ÊäïÁ•®')
  }
})

// ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ
const handleKeyPress = (event) => {
  if (!currentMatch.value || isVoting.value) return
  
  switch (event.key) {
    case '1':
    case 'ArrowUp':
      vote(currentMatch.value.user1.id)
      break
    case '2':  
    case 'ArrowDown':
      vote(currentMatch.value.user2.id)
      break
    case ' ':
    case 'Escape':
      event.preventDefault()
      skipMatch()
      break
  }
}

onMounted(() => {
  document.addEventListener('keydown', handleKeyPress)
  document.addEventListener('click', handleClickOutside)
})

onBeforeUnmount(() => {
  document.removeEventListener('keydown', handleKeyPress)
  document.removeEventListener('click', handleClickOutside)
})
</script>

<style scoped>
.voting {
  pointer-events: none;
  opacity: 0.7;
}

.vote-success-enter-active,
.vote-success-leave-active {
  transition: all 0.5s ease;
}

.vote-success-enter-from,
.vote-success-leave-to {
  opacity: 0;
  transform: scale(0.8);
}

/* Ëß¶Êë∏ÂèçÈ¶à */
@media (hover: none) {
  .photo-card:active {
    transform: scale(0.98);
  }
}

/* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÊåÅÂèØÊªöÂä® */
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
</style>
